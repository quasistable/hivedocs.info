<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to fix canonical URLs and links in your pre-fork posts | Hive Chain Documentation</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="How to fix canonical URLs and links in your pre-fork posts" />
<meta name="author" content="holger80" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Your resource for various levels of Hive Documentation." />
<meta property="og:description" content="Your resource for various levels of Hive Documentation." />
<link rel="canonical" href="https://hive.blog/hive-139531/@holger80/how-to-fix-canonical-urls-and-links-in-your-pre-fork-posts" />
<meta property="og:url" content="https://hive.blog/hive-139531/@holger80/how-to-fix-canonical-urls-and-links-in-your-pre-fork-posts" />
<meta property="og:site_name" content="Hive Chain Documentation" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-23T07:20:12-07:00" />
<script type="application/ld+json">
{"description":"Your resource for various levels of Hive Documentation.","headline":"How to fix canonical URLs and links in your pre-fork posts","dateModified":"2020-05-23T07:20:12-07:00","datePublished":"2020-05-23T07:20:12-07:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://hive.blog/hive-139531/@holger80/how-to-fix-canonical-urls-and-links-in-your-pre-fork-posts"},"url":"https://hive.blog/hive-139531/@holger80/how-to-fix-canonical-urls-and-links-in-your-pre-fork-posts","author":{"@type":"Person","name":"holger80"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://hivedocs.info/feed.xml" title="Hive Chain Documentation" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-161692811-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js" integrity="sha256-iM4Yzi/zLj/IshPWMC1IluRxTtRjMqjPGd97TZ9yYpU=" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Cousine|Inconsolata" rel="stylesheet">
  <link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png">
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Hive Chain Documentation</a>

      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/news/">News</a><a class="page-link" href="/howto/">How To</a><a class="page-link" href="/links/">Useful Links</a><!-- HTML elements for search -->
          <input type="text" id="search-input" placeholder="Search" />
          
          <ul id="results-container"></ul>

          <script src="/assets/javascript/search.js"></script>
          <script>
            var sjs = SimpleJekyllSearch({
              searchInput: document.getElementById('search-input'),
              resultsContainer: document.getElementById('results-container'),
              json: '/search.json'
            })
          </script>
          <!-- <form style="float: right;" class="form-inline" method="get" action="http://www.google.com/search">
            <input type="hidden" name="sitesearch" value="hivedocs.info" />
            <input type="text" name="q" maxlength="255" placeholder="Search" />
          </form> -->
        </div>
      </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to fix canonical URLs and links in your pre-fork posts</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-05-23T07:20:12-07:00" itemprop="datePublished">May 23, 2020
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">
          <a href="https://hive.blog/@holger80">holger80</a>
        </span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    
<p>As you can see here, I have some links in my blogs written before the hive-fork pointing to steemit.com. It’s time to replace them all.</p>

<p><img src="https://images.hive.blog/DQmfDpnHj9kXEqo2ZXNSAkaPbFb4svFqWXLyUEdEuniqd3e/steemit%20link%20in%20my%20blog" alt="steemit link in my blog" /></p>

<p>Almost all blog posts written before the fork are written with apps that are not included in <a href="https://www.npmjs.com/package/@hivechain/hivescript">hivescript</a> and lead to problems with canonical URLs:</p>

<p>As it can be seen here, my old post <a href="https://peakd.com/beem/@holger80/update-for-beem-first-release-for-hf-21">update for beem: first release for HF 21</a> result in different canonical URLs on different front-ends. This is then handled as duplicated content by the search engines.
The post was written through palnet. As there is no entry for palnet in <a href="https://www.npmjs.com/package/@hivechain/hivescript">hivescript</a>, the front-ends to not know how to build a proper canonical URL:
<img src="https://images.hive.blog/DQmXe1t2QwJtizzVXDpG89GVNxyYAorFu6Tjj5LRnXkEJss/wrong%20canonical%20url" alt="wrong canonical url" /></p>

<h1 id="fixing-the-mess">Fixing The mess</h1>
<p>Fixing means:</p>

<ul>
  <li>replacing all steemit, steempeak, … links with relative links</li>
  <li>setting <code class="highlighter-rouge">canonical_url</code> for each post written before 2020-03-20, to fix canonical  URLs.</li>
</ul>

<h3 id="small-update">Small update</h3>
<p>The script uses now relative links, when found a link to steemit.com …, it will be replaced by a relative link. A relative link looks like: <code class="highlighter-rouge">[holger80](/@holger80)</code> and <code class="highlighter-rouge">[this post](/hive-139531/@holger80/how-to-fix-canonical-urls-and-links-in-your-pre-fork-posts)</code></p>

<h3 id="small-update-2">Small update 2</h3>
<p>There are now three boolean parameters, which can be used to set the following:</p>

<ul>
  <li><code class="highlighter-rouge">replace_steemit_links</code>: when True, steemit, … links will be replaced</li>
  <li><code class="highlighter-rouge">use_relative_links</code>: when True, relative links will be used (starting with <code class="highlighter-rouge">/</code>)</li>
  <li><code class="highlighter-rouge">add_canonical_url</code>: When True, a canonical_url is added to the metadata</li>
</ul>

<h3 id="small-update-3">Small update 3</h3>
<p>It is now possible to use the same script for fixing the canonical links on STEEM for all written post before the fork.
When you want to use the script on STEEM:</p>
<ul>
  <li>set <code class="highlighter-rouge">target_blockchain = "steem"</code></li>
</ul>

<p>When you want to use the script on HIVE:</p>
<ul>
  <li>set <code class="highlighter-rouge">target_blockchain = "hive"</code></li>
</ul>

<h3 id="python-code">Python code</h3>
<p>The following script is using beem and will do exactly this.</p>

<p>beem can be installed by</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install beem
</code></pre></div></div>
<p>or</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda install beem
</code></pre></div></div>

<p>Store the following as <code class="highlighter-rouge">fix_canonical_urls_hive.py</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">from</span> <span class="nn">beem</span> <span class="kn">import</span> <span class="n">Hive</span><span class="p">,</span> <span class="n">Steem</span>
<span class="kn">from</span> <span class="nn">beem.utils</span> <span class="kn">import</span> <span class="n">addTzInfo</span>
<span class="kn">from</span> <span class="nn">beem.account</span> <span class="kn">import</span> <span class="n">Account</span>
<span class="kn">from</span> <span class="nn">beem.comment</span> <span class="kn">import</span> <span class="n">Comment</span>
<span class="kn">from</span> <span class="nn">beem.nodelist</span> <span class="kn">import</span> <span class="n">NodeList</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">getpass</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="c1"># Parameter
</span>    <span class="n">canonical_url</span> <span class="o">=</span> <span class="s">"https://hive.blog"</span>
    <span class="n">replace_steemit_links</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">use_relative_links</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">add_canonical_url</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">target_blockchain</span> <span class="o">=</span> <span class="s">"hive"</span> <span class="c1"># can be hive or steem
</span>    <span class="c1"># ----
</span>    <span class="c1"># at least one option must be true
</span>    <span class="k">assert</span> <span class="n">replace_steemit_links</span> <span class="ow">or</span> <span class="n">add_canonical_url</span>
    <span class="k">assert</span> <span class="n">target_blockchain</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"hive"</span><span class="p">,</span> <span class="s">"steem"</span><span class="p">]</span>
    <span class="c1"># Canonical url must not end with /
</span>    <span class="k">if</span> <span class="n">canonical_url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"/"</span><span class="p">:</span>
        <span class="n">canonical_url</span> <span class="o">=</span> <span class="n">canonical_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nodelist</span> <span class="o">=</span> <span class="n">NodeList</span><span class="p">()</span>
    <span class="n">nodelist</span><span class="p">.</span><span class="n">update_nodes</span><span class="p">()</span>
    <span class="n">test_run_answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Do a test run? [y/n]"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test_run_answer</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"y"</span><span class="p">,</span> <span class="s">"Y"</span><span class="p">,</span> <span class="s">"yes"</span><span class="p">]:</span>
        <span class="n">test_run</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Doing a test run on %s!"</span> <span class="o">%</span> <span class="n">target_blockchain</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_run</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">test_run</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target_blockchain</span> <span class="o">==</span> <span class="s">"hive"</span><span class="p">:</span>
            <span class="n">blockchain_instance</span><span class="o">=</span> <span class="n">Hive</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">nodelist</span><span class="p">.</span><span class="n">get_hive_nodes</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blockchain_instance</span><span class="o">=</span> <span class="n">Steem</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="s">"https://api.steemit.com"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wif</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">.</span><span class="n">getpass</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="s">'Enter your posting key for %s.'</span> <span class="o">%</span> <span class="n">target_blockchain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_blockchain</span> <span class="o">==</span> <span class="s">"hive"</span><span class="p">:</span>
            <span class="n">blockchain_instance</span> <span class="o">=</span> <span class="n">Hive</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">nodelist</span><span class="p">.</span><span class="n">get_hive_nodes</span><span class="p">(),</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">wif</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blockchain_instance</span> <span class="o">=</span> <span class="n">Steem</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="s">"https://api.steemit.com"</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">wif</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">target_blockchain</span> <span class="o">==</span> <span class="s">"hive"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">blockchain_instance</span><span class="p">.</span><span class="n">is_hive</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">blockchain_instance</span><span class="p">.</span><span class="n">is_steem</span>

    <span class="n">account</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Account name ="</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">blockchain_instance</span><span class="o">=</span><span class="n">blockchain_instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_canonical_url</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Start to fix canonical_url on %s for %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_blockchain</span><span class="p">,</span> <span class="n">account</span><span class="p">[</span><span class="s">"name"</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">replace_steemit_links</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Start to replace steemit links on %s for %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_blockchain</span><span class="p">,</span> <span class="n">account</span><span class="p">[</span><span class="s">"name"</span><span class="p">]))</span>
    
    <span class="n">apps_with_cannonical_url</span> <span class="o">=</span> <span class="p">[</span><span class="s">"hiveblog"</span><span class="p">,</span> <span class="s">"peakd"</span><span class="p">,</span> <span class="s">"esteem"</span><span class="p">,</span> <span class="s">"steempress"</span><span class="p">,</span> <span class="s">"actifit"</span><span class="p">,</span>
                                <span class="s">"travelfeed"</span><span class="p">,</span> <span class="s">"3speak"</span><span class="p">,</span> <span class="s">"steemstem"</span><span class="p">,</span> <span class="s">"leofinance"</span><span class="p">,</span> <span class="s">"clicktrackprofit"</span><span class="p">,</span>
                                <span class="s">"dtube"</span><span class="p">]</span>
    <span class="n">hive_fork_date</span> <span class="o">=</span> <span class="n">addTzInfo</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">blog_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">expected_count</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">while</span> <span class="n">expected_count</span> <span class="o">-</span> <span class="n">blog_count</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
        
        <span class="k">for</span> <span class="n">blog</span> <span class="ow">in</span> <span class="n">account</span><span class="p">.</span><span class="n">get_blog_entries</span><span class="p">(</span><span class="n">start_entry_id</span><span class="o">=</span><span class="n">blog_count</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="n">blog_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">blog</span><span class="p">[</span><span class="s">"parent_author"</span><span class="p">]</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">blog</span><span class="p">[</span><span class="s">"author"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">account</span><span class="p">[</span><span class="s">"name"</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s">"canonical_url"</span> <span class="ow">in</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span> <span class="ow">and</span> <span class="n">canonical_url</span> <span class="ow">in</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span><span class="p">[</span><span class="s">"canonical_url"</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s">"app"</span> <span class="ow">in</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span> <span class="ow">and</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span><span class="p">[</span><span class="s">"app"</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"/"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">apps_with_cannonical_url</span> <span class="ow">and</span> <span class="n">target_blockchain</span> <span class="o">==</span> <span class="s">"hive"</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">blog</span><span class="p">[</span><span class="s">"created"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">hive_fork_date</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">blog</span><span class="p">.</span><span class="n">body</span>
            <span class="k">if</span> <span class="s">"links"</span> <span class="ow">in</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span><span class="p">[</span><span class="s">"links"</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">"links"</span> <span class="ow">in</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span> <span class="ow">and</span> <span class="n">replace_steemit_links</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span><span class="p">[</span><span class="s">"links"</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s">"steemit.com"</span> <span class="ow">in</span> <span class="n">link</span> <span class="ow">or</span> <span class="s">"steempeak.com"</span> <span class="ow">in</span> <span class="n">link</span> <span class="ow">or</span> <span class="s">"busy.org"</span> <span class="ow">in</span> <span class="n">link</span> <span class="ow">or</span> <span class="s">"partiko.app"</span> <span class="ow">in</span> <span class="n">link</span><span class="p">:</span>
                        <span class="n">authorperm</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"@"</span><span class="p">)</span>
                        <span class="n">acc</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">post</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">new_link</span> <span class="o">=</span> <span class="s">""</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">authorperm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">authorperm</span> <span class="o">=</span> <span class="n">authorperm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">authorperm</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">acc</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">authorperm</span><span class="p">,</span> <span class="n">blockchain_instance</span><span class="o">=</span><span class="n">blockchain_instance</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">use_relative_links</span><span class="p">:</span>
                                    <span class="n">new_link</span> <span class="o">=</span> <span class="s">"/@"</span> <span class="o">+</span> <span class="n">acc</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_link</span> <span class="o">=</span> <span class="n">canonical_url</span> <span class="o">+</span> <span class="s">"/@"</span> <span class="o">+</span> <span class="n">acc</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">post</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">authorperm</span><span class="p">,</span> <span class="n">blockchain_instance</span><span class="o">=</span><span class="n">blockchain_instance</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">use_relative_links</span><span class="p">:</span>
                                    <span class="n">new_link</span> <span class="o">=</span>  <span class="s">"/"</span> <span class="o">+</span> <span class="n">post</span><span class="p">.</span><span class="n">category</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">post</span><span class="p">.</span><span class="n">authorperm</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_link</span> <span class="o">=</span>  <span class="n">canonical_url</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">post</span><span class="p">.</span><span class="n">category</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">post</span><span class="p">.</span><span class="n">authorperm</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">new_link</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">link</span><span class="p">:</span>
                                    <span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_link</span>
                            <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">new_link</span><span class="p">)</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">"Replace %s with %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">new_link</span><span class="p">))</span>
                            
            <span class="n">json_metadata</span> <span class="o">=</span> <span class="n">blog</span><span class="p">.</span><span class="n">json_metadata</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">links</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">replace_steemit_links</span><span class="p">:</span>
                <span class="n">json_metadata</span><span class="p">[</span><span class="s">"links"</span><span class="p">]</span> <span class="o">=</span> <span class="n">links</span>            
            <span class="k">if</span> <span class="n">add_canonical_url</span><span class="p">:</span>
                <span class="n">json_metadata</span><span class="p">[</span><span class="s">"canonical_url"</span><span class="p">]</span> <span class="o">=</span> <span class="n">canonical_url</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">blog</span><span class="p">[</span><span class="s">"category"</span><span class="p">]</span> <span class="o">+</span> <span class="s">"/@"</span> <span class="o">+</span> <span class="n">blog</span><span class="p">[</span><span class="s">"author"</span><span class="p">]</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">blog</span><span class="p">[</span><span class="s">"permlink"</span><span class="p">]</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Edit post nr %d with canonical_url=%s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">blog_count</span><span class="p">,</span> <span class="n">json_metadata</span><span class="p">[</span><span class="s">"canonical_url"</span><span class="p">]))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"---"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">blog</span><span class="p">.</span><span class="n">edit</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">json_metadata</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">"Skipping %s due to error"</span> <span class="o">%</span> <span class="n">blog</span><span class="p">.</span><span class="n">authorperm</span><span class="p">)</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="n">expected_count</span> <span class="o">+=</span> <span class="mi">100</span>
    
    
</code></pre></div></div>

<p>You can now start the script with:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python fix_canonical_urls_hive.py
</code></pre></div></div>
<p>If you are on Linux, you should replace <code class="highlighter-rouge">pip</code> by <code class="highlighter-rouge">pip3</code> and <code class="highlighter-rouge">python</code> by <code class="highlighter-rouge">python3</code>.</p>

<h2 id="how-does-it-work">How does it work</h2>
<p>The script goes through all blog posts written before 2020-03-14. Whenever the post was written by an app, that is not properly handled by <a href="https://www.npmjs.com/package/@hivechain/hivescript">hivescript</a>, a new canonical_url is set.</p>

<p>You can define your preferred front-end here:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>canonical_url = "https://hive.blog"
</code></pre></div></div>
<p>If you like other front-ends, you can replace this line by</p>
<ul>
  <li><code class="highlighter-rouge">canonical_url = "https://peakd.com"</code></li>
  <li><code class="highlighter-rouge">canonical_url = "https://leofinance.io"</code></li>
  <li><code class="highlighter-rouge">canonical_url = "https://esteem.app"</code></li>
</ul>

<p>In the next step, all used links are checked. Whenever a link is pointing to a valid hive post or to a valid hive user, the link is replaced by a releative url (When the link was pointing to steemit.com, steempeak.com, busy.org or partiko.app).</p>

<h2 id="test-run">Test run</h2>
<p>You can do a test run and checking what will be changed by the script:
<img src="https://images.hive.blog/DQmZht6KJmnJkBGebgwyXdGBpj4dSCCYkdqwzn6PpwD4ado/test_run" alt="test_run" /></p>

<p>This show now the following information:</p>

<p><img src="https://images.hive.blog/DQmWE3JdvZBYJauzmAHjFFnsCwyuZ6YBHzonbbSbtPf5Gdx/test%20result" alt="test result" />
The set canonical url is shown as well all links that will be replaced.</p>

<h2 id="fixing-your-posts">Fixing your posts</h2>
<p>We can now start to fix all old posts:
<img src="https://images.hive.blog/DQmdaFJFkxsAaMmc8wG5vESFwRGqPJwRR2GPXySJtvEAxKh/starting%20the%20script" alt="starting the script" /></p>

<h2 id="results">Results</h2>
<p>All changes have been broadcasted:
<img src="https://images.hive.blog/DQmNq6JKN9Cr5mDkBMsEcL8nCqRvH7ktkprTNXTU75K4Pz4/Broadcasted%20posts" alt="Broadcasted posts" /></p>

<p>The links have been corrected, as shown here:
<img src="https://images.hive.blog/DQmUFVmj9vW84ZH1aa2V4PfSKHsJLsARDUkWbo62KpxnnfA/image" alt="" />
There seems to be a bug with hive.blog, that steemit.com links are shown as internal and hive.blog links are shown as external links.</p>

<p>The canonical url is also fixed:</p>

<p><img src="https://images.hive.blog/DQmVjxuvCHYtfaS2p6c9i4wj43siJUMJciB2gwKE8dn5RMs/canonical%20urls" alt="canonical urls" /></p>

<p>It seems that esteem.app has not changed its canonical url right now. As I know that esteem.app should read the <code class="highlighter-rouge">canonical_url</code> parameter (works for steempress), it may correct the canonical URLs later.</p>

<p>After a fix on esteem.app, esteem.app is using now the correct canonical url:
<img src="https://images.hive.blog/DQmcbaPV3teUczT5WmxuaMybeyz4hdTEbaG5NV6kQ2HGHhj/canonical%20url%20from%20esteem.app" alt="canonical url from esteem.app" /></p>

<h2 id="results-on-steem">Results on STEEM</h2>
<p>Setting <code class="highlighter-rouge">canonical_url</code> works also on steemit:</p>

<p><img src="https://images.hive.blog/DQmShxP35w4ARXfryjEdsdWnuVKV1zebkSoRgbGCjTQRQbC/canonical%20url%20on%20steemit" alt="canonical url on steemit" /></p>

<p>I used <a href="https://www.seoreviewtools.com/canonical-url-location-checker/">seoreviewtools</a> to check the canonical urls.</p>

<hr />

<p><em>If you like what I do, consider casting a vote for me as witness on <a href="https://hivesigner.com/sign/account-witness-vote?witness=holger80&amp;approve=1">Hivesigner</a> or on <a href="https://peakd.com/witnesses">PeakD</a></em></p>

<hr />

<p>
  See: <a href="https://hive.blog/hive-139531/@holger80/how-to-fix-canonical-urls-and-links-in-your-pre-fork-posts">How to fix canonical URLs and links in your pre-fork posts</a>
  by
  <a href="https://hive.blog/@holger80">@holger80</a>
</p>


  </div><a class="u-url" href="/howto/beem/python/content/2020/05/23/how-to-fix-canonical-urls-and-links-in-your-pre-fork-posts.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"><a rel="author" href="/">Hive Chain Documentation</a></h2>
    
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">site curated by: @inertia</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Your resource for various levels of Hive Documentation.</p>
      </div>
    </div>
  </div>

</footer>
</body>

</html>
