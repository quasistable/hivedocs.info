<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content="/assets/images/sticker.png" /><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>7th update of 2022 on BlockTrades work on Hive software | Hive Chain Documentation</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="7th update of 2022 on BlockTrades work on Hive software" />
<meta name="author" content="blocktrades" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hive-related programming issues worked on by the BlockTrades team since my last post." />
<meta property="og:description" content="Hive-related programming issues worked on by the BlockTrades team since my last post." />
<link rel="canonical" href="https://hive.blog/hive-139531/@blocktrades/7th-update-of-2022-on-blocktrades-work-on-hive-software" />
<meta property="og:url" content="https://hive.blog/hive-139531/@blocktrades/7th-update-of-2022-on-blocktrades-work-on-hive-software" />
<meta property="og:site_name" content="Hive Chain Documentation" />
<meta property="og:image" content="https://images.hive.blog/DQmSihw8Kz4U7TuCQa98DDdCzqbqPFRumuVWAbareiYZW1Z/blocktrades%20update.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-05T14:11:51-07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://images.hive.blog/DQmSihw8Kz4U7TuCQa98DDdCzqbqPFRumuVWAbareiYZW1Z/blocktrades%20update.png" />
<meta property="twitter:title" content="7th update of 2022 on BlockTrades work on Hive software" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"blocktrades"},"description":"Hive-related programming issues worked on by the BlockTrades team since my last post.","url":"https://hive.blog/hive-139531/@blocktrades/7th-update-of-2022-on-blocktrades-work-on-hive-software","mainEntityOfPage":{"@type":"WebPage","@id":"https://hive.blog/hive-139531/@blocktrades/7th-update-of-2022-on-blocktrades-work-on-hive-software"},"image":"https://images.hive.blog/DQmSihw8Kz4U7TuCQa98DDdCzqbqPFRumuVWAbareiYZW1Z/blocktrades%20update.png","headline":"7th update of 2022 on BlockTrades work on Hive software","dateModified":"2022-05-05T14:11:51-07:00","datePublished":"2022-05-05T14:11:51-07:00","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://hivedocs.info/feed.xml" title="Hive Chain Documentation" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-161692811-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  
  <!-- jQuery Modal -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js" integrity="sha256-iM4Yzi/zLj/IshPWMC1IluRxTtRjMqjPGd97TZ9yYpU=" crossorigin="anonymous"></script>
  <script src='https://unpkg.com/steem-content-renderer'></script>
  <script>
    (function () {
      if (Turbolinks.supported) {
        Turbolinks.setProgressBarDelay(500);
      }
    })();
  </script>
  <script src="/assets/javascript/universal-bridge-against-phishing.js"></script>
  <script src="/assets/javascript/lazysizes.min.js" async=""></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Cousine|Inconsolata" rel="stylesheet">
  <link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png">
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Hive Chain Documentation</a>

      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/news/">News</a><a class="page-link" href="/howto/">How To</a><a class="page-link" href="/links/">Useful Links</a><a class="page-link" href="/authors/">Authors</a><!-- HTML elements for search -->
          <input type="text" id="search-input" placeholder="Search" />
          
          <ul id="results-container"></ul>

          <script src="/assets/javascript/search.js"></script>
          <script>
            var sjs = SimpleJekyllSearch({
              searchInput: document.getElementById('search-input'),
              resultsContainer: document.getElementById('results-container'),
              json: '/search.json'
            })
          </script>
          <!-- <form style="float: right;" class="form-inline" method="get" action="http://www.google.com/search">
            <input type="hidden" name="sitesearch" value="hivedocs.info" />
            <input type="text" name="q" maxlength="255" placeholder="Search" />
          </form> -->
          
          <!-- <a href="#" onclick="try { $('#authors-container').slideToggle(); } catch { document.getElementById('authors-container').style.display = 'block'; }; return false;">Authors &#187;</a>
          <a href="#" onclick="try { $('#topics-container').slideToggle(); } catch { document.getElementById('topics-container').style.display = 'block'; }; return false;">Topics &#187;</a> -->
          
          <a href="#topics-container" rel="modal:open">Topics &#187;</a>
          
          <div id="topics-container" class="modal">
            <h3>Topics</h3>
            <ul><li><a class="page-link" href="/account-recovery/"><nobr>Account Recovery</nobr></a></li><li><a class="page-link" href="/core-development/"><nobr>Core Development</nobr></a></li><li><a class="page-link" href="/dapps/"><nobr>Dapps</nobr></a></li><li><a class="page-link" href="/docker/"><nobr>Docker</nobr></a></li><li><a class="page-link" href="/hardfork/"><nobr>Hardfork</nobr></a></li><li><a class="page-link" href="/hivemind/"><nobr>Hivemind</nobr></a></li><li><a class="page-link" href="/javascript/"><nobr>Javascript</nobr></a></li><li><a class="page-link" href="/multisig/"><nobr>Multisig</nobr></a></li><li><a class="page-link" href="/python/"><nobr>Python</nobr></a></li><li><a class="page-link" href="/ruby/"><nobr>Ruby</nobr></a></li><li><a class="page-link" href="/testnet/"><nobr>Testnet</nobr></a></li><li><a class="page-link" href="/tools/"><nobr>Tools</nobr></a></li><li><a class="page-link" href="/witness/"><nobr>Witness</nobr></a></li></ul>
          </div>
        </div>
      </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <div class="pull-right well">
      <img src="https://images.hive.blog/u/blocktrades/avatar" width="128" height="128" class="lazyload" />
    </div>
    
    <h1 class="post-title p-name" itemprop="name headline">7th update of 2022 on BlockTrades work on Hive software</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-05-05T14:11:51-07:00" itemprop="datePublished">May 5, 2022
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">
          <a href="/authors/#author-blocktrades">blocktrades</a>
        </span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div id="content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software">![blocktrades update.png](https://images.hive.blog/DQmSihw8Kz4U7TuCQa98DDdCzqbqPFRumuVWAbareiYZW1Z/blocktrades%20update.png)

Below are highlights of some of the Hive-related programming issues worked on by the BlockTrades team since my last post.

# Hived (blockchain node software) work


### Mirrornet (testnet that mirrors traffic from mainnet) to test p2p code

We started testing the develop branch of hived with the mirrornet code this week. In this process, we found and fixed a couple of problems with the mirrornet itself (it wasn’t compatible with default BOOST library on Ubuntu20 and transactions ported from blocks in the mainnet were using the block time as their expiration time instead of their original expiration time). 

More importantly, we found a longstanding performance issue with the peer-to-peer code that limits the rate at which transactions can be shared over the network: each node requests at most one transaction at a time from each of its peers. 

So, for example, with an average latency of 100ms to all its peers, a node could get at most 30 transactions per peer during a block interval (3s block interval / 0.1s = 30). 

This problem showed up very clearly when we were testing a mirror net configured with only 3 nodes, with one node receiving the transactions from the mirrornet and sharing the transactions to a close-by node (1ms latency) and a far-away node (200ms latency). The close-by node was able to receive the transactions in a timely manner and fill it’s blocks with transactions, but the far-away node was receiving transactions at such a low transaction rate that it got the transactions after they were either expired or put into the other producer’s block, so it was only able to create 0-transaction blocks. 

Empirically, we’ve observed this problem occasionally on the mainnet as well, for nodes that are far away from the other nodes during high-traffic times, but the problems have been transient and therefore difficult to analyze. In the more constrained environment of the mirrornet the problem was much easier to reproduce and analyze because we had full control of the network topology and access to all the nodes in the network. It was also helpful to be able to run all the nodes with the new p2p code, since that allowed us to discount potential performance problems that were already fixed related to the locking protocol between the p2p code and the blockchain processing code during our search for the performance bottleneck.

### Planned p2p performance enhancement

To address the issue above, we’re updating the p2p code to allow a node to request more than one transaction at a time from a peer. This brings up issues of how a node can best load balance its transaction requests to its peers, since multiple peers can have the same set of transactions the node wants to fetch. 

Previously, load balancing was achieved automatically: since we only allowed one active request to any peer, the node would just round-robin its requests to peers, for the most part. Since we are now allowing multiple active requests to a peer, we need a new load-balancing algorithm. We’re using two simple heuristics for this: 1) the code won’t request more than 100 transactions from any given peer at a time and 2) we will favor peers that have low latency over high latency. This should result in transactions getting shared to peers as quickly as possible.

As a side note, I suspect that the above performance problem has probably been limiting average block size as well and preventing many “full” blocks, so once we’ve implemented the above enhancement we will also take a look at how the updated code functions in scenarios where we get a series of “full blocks” since this has never been tested much (if at all) in the past.

### Completed implementation of OBI (one-block irreversibility) protocol
As mentioned last week, the new block finality protocol has been coded and is waiting for testing resources to free up. I’ll publish a separate post about the implementation and effects of the new protocol on Monday.

# Hive Application Framework (HAF)

### Reduced size of hashes stored in HAF databases
As reported last week, we’ve changed the storage mechanism now to store them as a pure binary hash, which reduces the size of the transactions table (and some indexes) and also should improve performance somewhat. Benchmarking showed that this reduced overall HAF database size by about 10%.

### Benchmarking of various HAF server configurations (using ZFS in particular)

We’ve continued to benchmark HAF running in various hardware and software configurations to figure out optimal configurations for HAF servers in terms of performance and cost effectiveness. The majority of the experiments we’ve done so far are recorded here (it doesn’t include some of the more exotic tests we’ve done such as enabling huge_pages and use of postgres CLUSTER command, nor does it include a set of various pg_bench tests we’ve performed yet): https://gitlab.syncad.com/hive/haf/-/wikis/benchmarks

### Dockerized version of HAF server

We’ve begun experimenting with various dockerized variations of a HAF server, to determine which configuration will offer the most performance while offering the easiest options for server setup and administration.

# HAF account history app (aka hafah)

We’ve created a dockerized version of hafah (with postgrest server) that will be used by CI tests, and we’ll be adding performance results for it to the benchmark table above soon (hopefully tonight). 

Assuming this version performs as well as expected based on previous standalone benchmarks, we’ll replace the current python-based hafah with the dockerized postgrest-based one on our production API node (api.hive.blog) in the next few days.

# Hivemind (social media middleware server used by web sites)

This week we identified and fixed the remaining test fails for the new HAF-based hivemind that replaces the old hivemind, so the next steps will be to do some cleanup work and then begin performance testing.

# Some upcoming tasks

* Implement p2p protocol changes to increase transaction-sharing bandwidth and test changes on mirrornet.
* Modify hived to process transactions containing either NAI based assets or legacy assets.
* Complete work on resource credit rationalization.
* More dockerization and CI improvements for HAF and HAF apps.
* Collect benchmarks for a hafah app operating in “irreversible block mode” and compare to a hafah app operating in “normal” mode.
* Test postgrest-based hafah on production server (api.hive.blog).
* Clean up and benchmarking of HAF-based hivemind. If this goes well, we will also deploy and test on our API node.
* Finished testing of new one-block irreversibility (OBI) code.

# When hardfork 26?

Two weeks ago we were mostly in a “testing-only” mode, so I was hopeful we could still complete the hardfork by the end of this month, since we only had one outstanding big change to hived (RC credit rationalization). But yesterday we discovered that we needed to code up two new features: a fix for the p2p bottleneck and support for transactions with NAI and legacy assets in hived (originally it appeared that this work was complete, but further investigation revealed that there were cases that weren’t covered).

With three significant code changes still to be made to hived, I think it is best to push back the hardfork date till the end of next month, in order to allow proper testing time for all these new changes once they are implemented (especially as the last two tasks are being done by the same developer).</div>
<script crossorigin="anonymous" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

<script src="https://unpkg.com/steem-content-renderer"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/hive-content-renderer/dist/hive-content-renderer.min.js"></script> -->
<script>
  $(document).ready(function() {
    try {
      const renderer = new SteemContentRenderer.DefaultRenderer({
      // const renderer = new HiveContentRenderer({
        baseUrl: "https://hive.blog/",
        breaks: true,
        skipSanitization: false,
        allowInsecureScriptTags: false,
        addNofollowToLinks: true,
        doNotShowImages: false,
        ipfsPrefix: "",
        assetsWidth: 640,
        assetsHeight: 480,
        imageProxyFn: (url) => url,
        usertagUrlFn: (account) => "/@blocktrades",
        hashtagUrlFn: (hashtag) => "/7th-update-of-2022-on-blocktrades-work-on-hive-software",
        isLinkSafeFn: (url) => true,
      });
      
      const inputElem = $('#content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software').html();
      const outputElem = $('#content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software');
      const output = renderer.render(inputElem);
      
      outputElem.html(output);
    } catch(e) {
      console.log(e);
    }
  });
</script>

<style>
  #content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software {
    padding: 0 3rem;
    color: #444444;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-size: 16px;
    line-height: 1.8;
    text-shadow: 0 1px 0 #ffffff;
    padding: 0.5rem;
  }
  #content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software code {
    background: white;
  }
  #content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software a {
    border-bottom: 1px solid #444444; color: #444444; text-decoration: none;
  }
  #content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software a:hover {
    border-bottom: 0;
  }
  #content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software h1 {
    font-size: 2.2em;
  }
  #content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software h2, h3, h4, h5 {
    margin-bottom: 0;
  }
  #content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software header small {
    color: #999;
    font-size: 50%;
  }
  #content-blocktrades-7th-update-of-2022-on-blocktrades-work-on-hive-software img {
    max-width: 100%;
  }
</style>

<hr />

<p>
  See: <a href="https://hive.blog/hive-139531/@blocktrades/7th-update-of-2022-on-blocktrades-work-on-hive-software">7th update of 2022 on BlockTrades work on Hive software</a>
  by
  <a href="https://hive.blog/@blocktrades">@blocktrades</a>
</p>


  </div><a class="u-url" href="/news/core/development/2022/05/05/7th-update-of-2022-on-blocktrades-work-on-hive-software.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"><a rel="author" href="/">Hive Chain Documentation</a></h2>
    
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">site curated by: @inertia</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Your resource for various levels of Hive Documentation.</p>
      </div>
    </div>
  </div>

</footer>
</body>

</html>
