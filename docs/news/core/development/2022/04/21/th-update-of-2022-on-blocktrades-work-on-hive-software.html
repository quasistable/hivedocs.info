<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content="/assets/images/sticker.png" /><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>6th update of 2022 on BlockTrades work on Hive software | Hive Chain Documentation</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="6th update of 2022 on BlockTrades work on Hive software" />
<meta name="author" content="blocktrades" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hive-related programming issues worked on by the BlockTrades team since my last post." />
<meta property="og:description" content="Hive-related programming issues worked on by the BlockTrades team since my last post." />
<link rel="canonical" href="https://hive.blog/hive-139531/@blocktrades/th-update-of-2022-on-blocktrades-work-on-hive-software" />
<meta property="og:url" content="https://hive.blog/hive-139531/@blocktrades/th-update-of-2022-on-blocktrades-work-on-hive-software" />
<meta property="og:site_name" content="Hive Chain Documentation" />
<meta property="og:image" content="https://images.hive.blog/DQmSihw8Kz4U7TuCQa98DDdCzqbqPFRumuVWAbareiYZW1Z/blocktrades%20update.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-21T15:58:30-07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://images.hive.blog/DQmSihw8Kz4U7TuCQa98DDdCzqbqPFRumuVWAbareiYZW1Z/blocktrades%20update.png" />
<meta property="twitter:title" content="6th update of 2022 on BlockTrades work on Hive software" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"blocktrades"},"description":"Hive-related programming issues worked on by the BlockTrades team since my last post.","url":"https://hive.blog/hive-139531/@blocktrades/th-update-of-2022-on-blocktrades-work-on-hive-software","mainEntityOfPage":{"@type":"WebPage","@id":"https://hive.blog/hive-139531/@blocktrades/th-update-of-2022-on-blocktrades-work-on-hive-software"},"image":"https://images.hive.blog/DQmSihw8Kz4U7TuCQa98DDdCzqbqPFRumuVWAbareiYZW1Z/blocktrades%20update.png","headline":"6th update of 2022 on BlockTrades work on Hive software","dateModified":"2022-04-21T15:58:30-07:00","datePublished":"2022-04-21T15:58:30-07:00","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://hivedocs.info/feed.xml" title="Hive Chain Documentation" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-161692811-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  
  <!-- jQuery Modal -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js" integrity="sha256-iM4Yzi/zLj/IshPWMC1IluRxTtRjMqjPGd97TZ9yYpU=" crossorigin="anonymous"></script>
  <script src='https://unpkg.com/steem-content-renderer'></script>
  <script>
    (function () {
      if (Turbolinks.supported) {
        Turbolinks.setProgressBarDelay(500);
      }
    })();
  </script>
  <script src="/assets/javascript/universal-bridge-against-phishing.js"></script>
  <script src="/assets/javascript/lazysizes.min.js" async=""></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Cousine|Inconsolata" rel="stylesheet">
  <link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png">
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Hive Chain Documentation</a>

      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/news/">News</a><a class="page-link" href="/howto/">How To</a><a class="page-link" href="/links/">Useful Links</a><a class="page-link" href="/authors/">Authors</a><!-- HTML elements for search -->
          <input type="text" id="search-input" placeholder="Search" />
          
          <ul id="results-container"></ul>

          <script src="/assets/javascript/search.js"></script>
          <script>
            var sjs = SimpleJekyllSearch({
              searchInput: document.getElementById('search-input'),
              resultsContainer: document.getElementById('results-container'),
              json: '/search.json'
            })
          </script>
          <!-- <form style="float: right;" class="form-inline" method="get" action="http://www.google.com/search">
            <input type="hidden" name="sitesearch" value="hivedocs.info" />
            <input type="text" name="q" maxlength="255" placeholder="Search" />
          </form> -->
          
          <!-- <a href="#" onclick="try { $('#authors-container').slideToggle(); } catch { document.getElementById('authors-container').style.display = 'block'; }; return false;">Authors &#187;</a>
          <a href="#" onclick="try { $('#topics-container').slideToggle(); } catch { document.getElementById('topics-container').style.display = 'block'; }; return false;">Topics &#187;</a> -->
          
          <a href="#topics-container" rel="modal:open">Topics &#187;</a>
          
          <div id="topics-container" class="modal">
            <h3>Topics</h3>
            <ul><li><a class="page-link" href="/account-recovery/"><nobr>Account Recovery</nobr></a></li><li><a class="page-link" href="/core-development/"><nobr>Core Development</nobr></a></li><li><a class="page-link" href="/dapps/"><nobr>Dapps</nobr></a></li><li><a class="page-link" href="/docker/"><nobr>Docker</nobr></a></li><li><a class="page-link" href="/hardfork/"><nobr>Hardfork</nobr></a></li><li><a class="page-link" href="/hivemind/"><nobr>Hivemind</nobr></a></li><li><a class="page-link" href="/javascript/"><nobr>Javascript</nobr></a></li><li><a class="page-link" href="/multisig/"><nobr>Multisig</nobr></a></li><li><a class="page-link" href="/python/"><nobr>Python</nobr></a></li><li><a class="page-link" href="/ruby/"><nobr>Ruby</nobr></a></li><li><a class="page-link" href="/testnet/"><nobr>Testnet</nobr></a></li><li><a class="page-link" href="/tools/"><nobr>Tools</nobr></a></li><li><a class="page-link" href="/witness/"><nobr>Witness</nobr></a></li></ul>
          </div>
        </div>
      </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <div class="pull-right well">
      <img src="https://images.hive.blog/u/blocktrades/avatar" width="128" height="128" class="lazyload" />
    </div>
    
    <h1 class="post-title p-name" itemprop="name headline">6th update of 2022 on BlockTrades work on Hive software</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-04-21T15:58:30-07:00" itemprop="datePublished">Apr 21, 2022
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">
          <a href="/authors/#author-blocktrades">blocktrades</a>
        </span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div id="content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software">![blocktrades update.png](https://images.hive.blog/DQmSihw8Kz4U7TuCQa98DDdCzqbqPFRumuVWAbareiYZW1Z/blocktrades%20update.png)

Below are highlights of some of the Hive-related programming issues worked on by the BlockTrades team since my last post.

# Hived (blockchain node software) work

### Optimization of Resource Credit (RC) calculations
We’re currently analyzing how proposed changes to RC calculations will affect different types of Hive users. As a first step to this, we’re adding code to insert RC data generated during the replay of the blockchain into a database to give us a flexible analysis environment.

### Testing and fixing bugs in rc delegation and new wallet_api code
We’ve continued to create new tests to cover bugs discovered (and fixed) in RC delegation and wallet_api code. I believe this work will be completed by tomorrow.

### Testing the new p2p code with testtools-based testnets
Our new tests that simulate network forks enabled us to identify a few more bugs in the updated p2p/locking code (actually a couple of the bugs were in the existing fork database code, but the buggy code was never called during a fork switch previously because the p2p thread was always frozen during a fork switch due to the bad locking in the old code). We fixed the bugs and also made some further improvements to logging to ease diagnosis of any further bugs we might find (and also help in performance optimization). 

Currently there’s no further known bugs associated with p2p/locking changes, but our testers are scheduled to create further test scenarios (e.g. testing transition of nodes to the new hardfork protocol).

### Mirrornet (testnet that mirrors traffic from mainnet) to test p2p code

After a couple more bug fixes, the mirrornet code is “mostly working” now, but there’s still one issue as a node is replayed and first enters live sync. This bug will probably be fixed tomorrow, so I expect we can launch a new public mirrornet early next week. At this point it would be good to get more people to launch nodes on the mirrornet so we can get a nicely distributed network with differently configured nodes. 

We plan to use the new mirrornet to look at potential optimizations of the new hived nodes with better locking when they are under heavy load conditions (and to perform further testing, of course).

### Completed implementation of block finality protocol
The new block finality protocol has been coded and very lightly tested. 

Next we’ll begin creating CI tests to exercise this code under various stressed network conditions (e.g. simulating breaks in the p2p network connections). Despite the lack of a lot of testing yet, based on the cleanness of the design, I don’t expect many bugs in this code.

# Hive Application Framework (HAF)

### Reduced size of hashes stored in HAF databases
One of our new HAF app developers noticed a discrepancy in the way HAF was storing transaction hashes (and block hashes as well), and we ultimately found that the sql_serializer plugin was storing off the hex values as ASCII strings instead of encoded binary (so we were using 40 bytes to store the hash when we could be using only 20 bytes to do it). 

We’ve changed the storage mechanism now to store them as a pure binary hash, which will reduce the size of the transactions table (and some indexes) and also should improve performance somewhat. We’re currently running a benchmark to determine how much smaller the affected tables get after a full replay.

### Fix performance problem when a HAF app “breaks”
We found that if a HAF app stops processing blocks (e.g. there is some bug in the app’s code), this could cause reversible data to begin accumulating in the database instead of being moved to an irreversible state, and this could result in a slowdown of other still-working HAF apps running on that server. This was undesirable, since we want HAF apps to be isolated from each other, by default. Fortunately, we found a quick fix that essentially alleviates this issue and the fix was committed today.

### Filtering of operations to create small HAF servers

I benchmarked HAF database size for both forms of filtering for a HAF servers (1. account-based filtering similar to what is used by the account-history plugin and 2. operations-regex filtering which enables filtering out specific types of operations with particular data) and the news is quite good, although not unexpected. 

For example, using the operations/regex filtering to filter out just splinterlands game operations (but not hive engine ones), the HAF database size on a compressed ZFS drive dropped from 1200GB down to 359GB. This also reduced the time to recreate the database table indexes after the replay on our “typically configured server” from 5.5 hours down to 1.1 hour.

Even more impressively, a HAF database configured just to store account history data for popular Hive exchanges only consumed 5GB on a ZFS compressed drive (as opposed to 1200GB for a full HAF database). And most of that 5GB was consumed by the transactions table, so we may cut that size in half with the new reduced-size hashes mentioned above. 

Note that for many “stand-alone” HAF servers that are dedicated to a particular app or set of apps that mostly rely on custom_json, 5GB size is a realistic “minimum database size” requirement, with any additional data just being whatever is required by the apps themselves (i.e. storage of the app-specific custom_json and state tables for the app).

### Benchmarking of various HAF server configurations

We’ve continued to benchmark HAF running in various hardware and software configurations to figure out optimal configurations for HAF servers in terms of performance and cost effectiveness. 

Based on that benchmarking, we’ve modified the default maintenance_worker_mem setting from the default 64MB to 6GB while we’re re-building the indexes after a HAF replay. We’ll also be checking to see if this change will be very beneficial when performing table vacuums of various types (and therefore whether it should be increased some at other times or even permanently for the server).

Currently we’re analyzing temporarily disabling filesystem sync acknowledgment during initial population of a HAF database. Surprisingly, we haven’t seen a benefit from this yet, so we need to investigate further to figure out why. However, we did see substantial benefits in configuring drives used by the database to “noatime”.

# HAF account history app (aka hafah)
We’re currently enabling automated testing of the version of Hafah that uses PostgREST instead of a python-based web server. Our benchmarking so far continues to show a substantial benefit from using PostgREST, with one of the latest tests showing a 2x improvement in response time (100ms for a 500kb response versus 200ms in the python-based server) for a `get_ops_in_block` call (which was previously the biggest bottleneck during our Hafah benchmark test). I believe this work will be completed by tomorrow.

In related work, we’ve making further changes to our benchmarking script so that this data can be analyzed easily from our automated testing system so that we can easily see improvements or regressions whenever the code is changed.

# Hivemind (social media middleware server used by web sites)
We continued to work on conversion of Hivemind to a HAF-based app. The HAF-based version has been tested using our standard hivemind CI tests and only a small number of tests failed, so I expect we’ll have a usable version available soon that we can begin benchmarking.


# HAF-based block explorer
We’re still in the early stages of this project, but this work is what led to the discovery that we were storing the transaction hashes inefficiently and the issue with retaining reversible data for too long when a HAF app breaks, so it’s already yielding some useful benefits as a means of testing and improving HAF itself.

# Some upcoming tasks
 * Modify the one-step script for installing HAF to optionally download a trusted block_log and block_log.index file (or maybe just allow an option for fast-syncing using a checkpoint to reduce block processing time now that peer syncing process is faster and may actually perform better than downloading a block_log and replaying it). This task is on hold until we have someone free to work on it.
* Collect benchmarks for hafah operating in “irreversible block mode” and compare to a hafah operation in “normal” mode. Task is on hold until we’ve finished optimization of HAfAH (mainly just PostgREST benchmarking now).
* Further testing of hafah on production servers (api.hive.blog).
* Finish conversion of hivemind to a HAF-based app.
* More testing of new P2P code under forking conditions and various live mode scenarios and in a mirrornet testnet using only hived servers with the new P2P code.
* Finished testing of new block finality code.
* Complete work on resource credit rationalization.

# When hardfork 26?

We’re mostly in a “test and benchmarking” mode now, so if all goes well with testing in the next week, we may be able to schedule the next hardfork in late May.</div>
<script crossorigin="anonymous" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

<script src="https://unpkg.com/steem-content-renderer"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/hive-content-renderer/dist/hive-content-renderer.min.js"></script> -->
<script>
  $(document).ready(function() {
    try {
      const renderer = new SteemContentRenderer.DefaultRenderer({
      // const renderer = new HiveContentRenderer({
        baseUrl: "https://hive.blog/",
        breaks: true,
        skipSanitization: false,
        allowInsecureScriptTags: false,
        addNofollowToLinks: true,
        doNotShowImages: false,
        ipfsPrefix: "",
        assetsWidth: 640,
        assetsHeight: 480,
        imageProxyFn: (url) => url,
        usertagUrlFn: (account) => "/@blocktrades",
        hashtagUrlFn: (hashtag) => "/th-update-of-2022-on-blocktrades-work-on-hive-software",
        isLinkSafeFn: (url) => true,
      });
      
      const inputElem = $('#content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software').html();
      const outputElem = $('#content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software');
      const output = renderer.render(inputElem);
      
      outputElem.html(output);
    } catch(e) {
      console.log(e);
    }
  });
</script>

<style>
  #content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software {
    padding: 0 3rem;
    color: #444444;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-size: 16px;
    line-height: 1.8;
    text-shadow: 0 1px 0 #ffffff;
    padding: 0.5rem;
  }
  #content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software code {
    background: white;
  }
  #content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software a {
    border-bottom: 1px solid #444444; color: #444444; text-decoration: none;
  }
  #content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software a:hover {
    border-bottom: 0;
  }
  #content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software h1 {
    font-size: 2.2em;
  }
  #content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software h2, h3, h4, h5 {
    margin-bottom: 0;
  }
  #content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software header small {
    color: #999;
    font-size: 50%;
  }
  #content-blocktrades-th-update-of-2022-on-blocktrades-work-on-hive-software img {
    max-width: 100%;
  }
</style>

<hr />

<p>
  See: <a href="https://hive.blog/hive-139531/@blocktrades/th-update-of-2022-on-blocktrades-work-on-hive-software">6th update of 2022 on BlockTrades work on Hive software</a>
  by
  <a href="https://hive.blog/@blocktrades">@blocktrades</a>
</p>


  </div><a class="u-url" href="/news/core/development/2022/04/21/th-update-of-2022-on-blocktrades-work-on-hive-software.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"><a rel="author" href="/">Hive Chain Documentation</a></h2>
    
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">site curated by: @inertia</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Your resource for various levels of Hive Documentation.</p>
      </div>
    </div>
  </div>

</footer>
</body>

</html>
